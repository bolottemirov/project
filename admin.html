<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang="admin_panel_title">Админ-панель - Архив Подотчетности</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged, getFirestore, collection, query, onSnapshot, orderBy };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .header-bg {
            background-color: #0d2a4c;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
        }
        .nav-link {
            color: #ffffff;
            transition: color 0.3s ease;
        }
        .nav-link:hover {
            color: #009edb;
        }
        .message-item {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .message-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .message-item p strong {
            color: #4a5568;
        }
        .not-authorized {
            text-align: center;
            margin-top: 5rem;
            font-size: 1.5rem;
            color: #e53e3e;
            font-weight: bold;
        }
        .lang-switcher button.active {
            font-weight: bold;
            text-decoration: underline;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="header-bg text-white shadow-lg">
        <div class="container flex justify-between items-center py-4">
            <div class="flex items-center space-x-4">
                <a href="iindex.html" class="flex items-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/UN_emblem_blue.svg/1200px-UN_emblem_blue.svg.png" alt="UN Logo" class="h-10">
                    <span class="text-xl font-bold ml-2 hidden sm:block" data-lang="org_name">Архив Подотчетности</span>
                </a>
            </div>
            <nav class="flex items-center space-x-6">
                <a href="iindex.html" class="nav-link text-lg font-medium" data-lang-role="nav_home">Главная</a>
            </nav>
            <div class="lang-switcher flex items-center space-x-2">
                <button data-lang-code="ru" class="bg-gray-700 text-white text-sm font-semibold py-1 px-3 rounded-md transition-colors duration-200 hover:bg-gray-600">RU</button>
                <button data-lang-code="en" class="bg-gray-700 text-white text-sm font-semibold py-1 px-3 rounded-md transition-colors duration-200 hover:bg-gray-600">EN</button>
            </div>
            <div id="auth-status" class="flex items-center space-x-4">
                <div id="loading-auth" class="flex items-center text-sm hidden">
                    <div class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                    <span data-lang-role="loading_auth">Проверка...</span>
                </div>
                <div id="auth-info" class="text-sm">
                    <span id="user-info" class="mr-2 hidden"></span>
                    <button id="logout-button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 hidden" data-lang-role="logout_button">Выйти</button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow py-8">
        <div class="container">
            <h1 class="text-4xl font-extrabold mb-8 text-center" data-lang-role="admin_panel_heading">Панель администратора</h1>
            <div id="admin-content" class="hidden">
                <p class="text-xl mb-4" data-lang-role="welcome_admin">Добро пожаловать, администратор!</p>
                <p class="text-lg text-gray-700 mb-6" data-lang-role="admin_intro_text">Ниже представлены все сообщения обратной связи, отправленные пользователями. Данные обновляются в реальном времени.</p>
                <div id="loading-messages" class="text-center text-lg text-gray-500 hidden">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mr-2"></div>
                    <span data-lang-role="loading_messages">Загрузка сообщений...</span>
                </div>
                <div id="messages-container" class="grid gap-4">
                    <!-- Сообщения будут загружены здесь -->
                </div>
            </div>
            <div id="not-authorized-content" class="not-authorized hidden">
                <p data-lang-role="not_authorized_message">У вас нет прав для просмотра этой страницы.</p>
                <a href="iindex.html" class="mt-4 inline-block bg-blue-800 text-white font-bold py-2 px-6 rounded-full transition-transform duration-200 hover:scale-105" data-lang-role="back_to_home">Вернуться на главную</a>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-8 mt-auto">
        <div class="container text-center">
            <p>&copy; 2024 Архив Подотчетности. Все права защищены.</p>
        </div>
    </footer>

    <script type="module">
        const translations = {
            'ru': {
                admin_panel_title: "Админ-панель - Архив Подотчетности",
                org_name: "Архив Подотчетности",
                nav_home: "Главная",
                logout_button: "Выйти",
                loading_auth: "Проверка...",
                admin_panel_heading: "Панель администратора",
                welcome_admin: "Добро пожаловать, администратор!",
                admin_intro_text: "Ниже представлены все сообщения обратной связи, отправленные пользователями. Данные обновляются в реальном времени.",
                loading_messages: "Загрузка сообщений...",
                not_authorized_message: "У вас нет прав для просмотра этой страницы.",
                back_to_home: "Вернуться на главную",
                message_from: "От:",
                message_email: "Email:",
                message_user_id: "ID пользователя:",
                message_language: "Язык:",
                message_timestamp: "Время:",
                auth_error_message: "Ошибка аутентификации. Пожалуйста, попробуйте войти снова.",
                fetch_error_message: "Не удалось загрузить сообщения."
            },
            'en': {
                admin_panel_title: "Admin Panel - Accountability Archive",
                org_name: "Accountability Archive",
                nav_home: "Home",
                logout_button: "Log Out",
                loading_auth: "Checking...",
                admin_panel_heading: "Admin Panel",
                welcome_admin: "Welcome, Admin!",
                admin_intro_text: "Below are all the feedback messages sent by users. The data updates in real-time.",
                loading_messages: "Loading messages...",
                not_authorized_message: "You do not have permission to view this page.",
                back_to_home: "Back to Home",
                message_from: "From:",
                message_email: "Email:",
                message_user_id: "User ID:",
                message_language: "Language:",
                message_timestamp: "Timestamp:",
                auth_error_message: "Authentication error. Please try logging in again.",
                fetch_error_message: "Failed to load messages."
            }
        };

        let currentLang = 'ru';

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-lang-role]').forEach(element => {
                const originalRole = element.dataset.langRole;
                if (translations[lang] && translations[lang].hasOwnProperty(originalRole)) {
                    element.textContent = translations[lang][originalRole];
                }
            });
            document.querySelector('title').textContent = translations[lang].admin_panel_title;

            document.querySelectorAll('.lang-switcher button').forEach(button => {
                if (button.dataset.langCode === lang) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            localStorage.setItem('selectedLanguage', lang);
        }

        // ---------- Firebase Configuration and Initialization ----------
        const firebaseConfig = {
            apiKey: "AIzaSyAoS7SNm7gDe1EnTopa5e1qHumgWsH5NWY",
            authDomain: "archive-915cf.firebaseapp.com",
            projectId: "archive-915cf",
            storageBucket: "archive-915cf.firebasestorage.app",
            messagingSenderId: "368228036181",
            appId: "1:368228036181:web:86ded413accda15b64eedc"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseApp = firebase.initializeApp(firebaseConfig);
        const auth = firebase.getAuth(firebaseApp);
        const db = firebase.getFirestore(firebaseApp);

        // IMPORTANT: Replace these placeholders with your actual Firebase User UIDs
        const adminUIDs = ["YOUR_ADMIN_UID_1", "YOUR_ADMIN_UID_2"];

        // UI elements
        const adminContent = document.getElementById('admin-content');
        const notAuthorizedContent = document.getElementById('not-authorized-content');
        const messagesContainer = document.getElementById('messages-container');
        const loadingMessagesText = document.getElementById('loading-messages');
        const loadingAuth = document.getElementById('loading-auth');
        const logoutButton = document.getElementById('logout-button');
        const authInfo = document.getElementById('auth-info');

        let unsubscribe = null; // To store the onSnapshot listener function

        const toggleVisibility = (element, isVisible) => {
            if (isVisible) {
                element.classList.remove('hidden');
            } else {
                element.classList.add('hidden');
            }
        };

        // Function to fetch messages from Firestore
        const fetchMessages = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            toggleVisibility(loadingMessagesText, true);
            messagesContainer.innerHTML = '';

            const feedbackCollectionRef = firebase.collection(db, `/artifacts/${appId}/public/data/feedback`);
            const q = firebase.query(feedbackCollectionRef);

            // Using onSnapshot for real-time updates
            unsubscribe = firebase.onSnapshot(q, (querySnapshot) => {
                messagesContainer.innerHTML = '';
                toggleVisibility(loadingMessagesText, false);

                if (querySnapshot.empty) {
                    messagesContainer.innerHTML = `<p class="text-gray-500" data-lang-role="no_messages_text">Сообщений пока нет.</p>`;
                    return;
                }

                querySnapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    const msgElement = document.createElement('div');
                    msgElement.classList.add('message-item');
                    const timestampDate = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString(currentLang) : 'N/A';

                    msgElement.innerHTML = `
                        <p><strong>${translations[currentLang].message_from}</strong> ${msg.name}</p>
                        <p><strong>${translations[currentLang].message_email}</strong> ${msg.email}</p>
                        <p><strong>${translations[currentLang].message_user_id}</strong> ${msg.userId}</p>
                        <p><strong>${translations[currentLang].message_language}</strong> ${msg.language.toUpperCase()}</p>
                        <p><strong>${translations[currentLang].message_timestamp}</strong> ${timestampDate}</p>
                        <p class="mt-2">${msg.message}</p>
                    `;
                    messagesContainer.appendChild(msgElement);
                });
            }, (error) => {
                console.error("Error fetching messages:", error);
                toggleVisibility(loadingMessagesText, false);
                messagesContainer.innerHTML = `<p class="text-red-500">${translations[currentLang].fetch_error_message}: ${error.message}</p>`;
            });
        };

        // Event listener for Logout button
        logoutButton.addEventListener('click', async () => {
            try {
                await firebase.signOut(auth);
                window.location.href = 'iindex.html';
            } catch (error) {
                console.error("Error during sign out:", error);
            }
        });

        // Main auth state observer
        firebase.onAuthStateChanged(auth, (user) => {
            toggleVisibility(loadingAuth, false);

            if (user && adminUIDs.includes(user.uid)) {
                // User is an admin, show content
                toggleVisibility(adminContent, true);
                toggleVisibility(notAuthorizedContent, false);
                toggleVisibility(authInfo, true);
                toggleVisibility(logoutButton, true);
                fetchMessages();
            } else {
                // Not an admin or not signed in, show error message
                toggleVisibility(adminContent, false);
                toggleVisibility(notAuthorizedContent, true);
                toggleVisibility(authInfo, false);
                toggleVisibility(logoutButton, false);

                if (unsubscribe) {
                    unsubscribe();
                }
            }
        });

        // Initial language setup
        document.addEventListener('DOMContentLoaded', () => {
            const langButtons = document.querySelectorAll('.lang-switcher button');
            langButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    setLanguage(event.target.dataset.langCode);
                });
            });

            const savedLang = localStorage.getItem('selectedLanguage') || 'ru';
            setLanguage(savedLang);
        });
    </script>
</body>
</html>
